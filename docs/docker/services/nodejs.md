# NodeJs

## 准备一个简单的nodejs程序

首先创建一个空文件夹。并创建以下文件：

- server.js
- package.json
- Dockerfile
- .dockerignore

server.js 内容如下：

```javascript
const Koa = require('koa');
const app = new Koa();

app.use(async ctx => {
   ctx.body = 'Hello docker';
});

app.listen(3000);
```

package.json 内容如下：

```json
{
 "name": "docker_demo",
 "version": "0.1.0",
 "private": true,
 "scripts": {
   "start": "node server.js"
 },
 "dependencies": {
   "koa": "^2.5.0"
  }
}
```

安装node依赖包。

```
$ npm install
```

测试一下程序。

```
$ npm start
```

![nodejs 1](/static/images/nodejs_1.png)

## 创建dockerfile文件

Dockerfile是由一系列命令和参数构成的脚本，一个Dockerfile里面包含了构建整个image的完整命令。Docker通过docker build执行Dockerfile中的一系列命令自动构建image。

在.dockerignore文件里面写入代码。表示过滤该类型的文件。类似git的.gitignore

```
# Logs
logs
*.log
npm-debug.log*

# Runtime data
pids
*.pid
*.seed

# Directory for instrumented libs generated by jscoverage/JSCover
lib-cov

# Coverage directory used by tools like istanbul
coverage

# nyc test coverage
.nyc_output

# Grunt intermediate storage (http://gruntjs.com/creating-plugins#storing-task-files)
.grunt

# node-waf configuration
.lock-wscript

# Compiled binary addons (http://nodejs.org/api/addons.html)
build/Release

# Dependency directories
node_modules
jspm_packages

# Optional npm cache directory
.npm

# Optional REPL history
.node_repl_history
.idea
.node_modules
node_modules
.vscode
```

在Dockerfile文件中写入以下代码：

```
#制定node镜像的版本
FROM node:8.9-alpine
#声明作者
MAINTAINER robin
#移动当前目录下面的文件到app目录下
ADD . /app/
#进入到app目录下面，类似cd
WORKDIR /app
#安装依赖
RUN npm install
#对外暴露的端口
EXPOSE 3000
#程序启动脚本
CMD ["npm", "start"]
```

## 构建镜像

使用build命令构造镜像,注意后面那个.不能少。

```
$ docker build -t docker_demo .
```

等待镜像构造完成。然后使用 images命令查看镜像。

此时可以看到images已经构造完成。现在开始启动images，并测试。

```
#启动镜像 -d表示后台执行，-p 9000:3000表示指定本地的9000端口隐射到容器内的3000端口，docker_demo为镜像名称
$ docker run -d -p 9000:3000 docker_demo
#查看容器
$ docker ps
```

如果此时本地无法打开。可以使用log命令查看日志。根据日志修改对应出现问题。
